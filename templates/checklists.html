{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
        <div>
            <i class="bi bi-clipboard-check"></i> Controle de Checklists
        </div>
        <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#novoChecklistModal">
            <i class="bi bi-plus-circle"></i> Novo Checklist
        </button>
    </div>
    <div class="card-body">
        <!-- Filtros -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" id="filtroIdentificacao" class="form-control" placeholder="Filtrar por identificação...">
                </div>
            </div>
            <div class="col-md-3">
                <select id="filtroNivelOleo" class="form-select">
                    <option value="todos">Todos os níveis</option>
                    <option value="ADEQUADO">Nível Adequado</option>
                    <option value="BAIXO">Nível Baixo</option>
                    <option value="CRÍTICO">Nível Crítico</option>
                </select>
            </div>
            <div class="col-md-3">
                <input type="date" id="filtroData" class="form-control" placeholder="Filtrar por data...">
            </div>
            <div class="col-md-2">
                <button class="btn btn-outline-secondary w-100" onclick="limparFiltros()">
                    <i class="bi bi-x-circle"></i> Limpar
                </button>
            </div>
        </div>

        <!-- Tabela de Checklists -->
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="tabelaChecklists">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Identificação</th>
                        <th>Data</th>
                        <th class="text-end">Horímetro</th>
                        <th class="text-center">Nível de Óleo</th>
                        <th class="text-center">Ações</th>
                    </tr>
                </thead>
                <tbody id="corpoTabela">
                    {% for checklist in checklists %}
                    <tr id="row-{{ checklist.id }}">
                        <td>{{ checklist.id }}</td>
                        <td>{{ checklist.identificacao }}</td>
                        <td>{{ checklist.data }}</td>
                        <td class="text-end">{{ "%.1f"|format(checklist.horimetro) if checklist.horimetro else '-' }}</td>
                        <td class="text-center">
                            <span class="badge 
                                {% if checklist.nivel_oleo == 'ADEQUADO' %}bg-success
                                {% elif checklist.nivel_oleo == 'BAIXO' %}bg-warning
                                {% else %}bg-danger{% endif %}">
                                {{ checklist.nivel_oleo }}
                            </span>
                        </td>
                        <td class="text-center">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-info" onclick="detalhesChecklist({{ checklist,id }})" title="Detalhes">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-outline-primary" onclick="editarChecklist({{ checklist,id }})" title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="excluirChecklist({{ checklist,id }})" title="Excluir">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <i class="bi bi-inbox"></i>
                            <p class="text-muted">Nenhum checklist cadastrado.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Novo Checklist -->
<div class="modal fade" id="novoChecklistModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Novo Checklist</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="formNovoChecklist">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Identificação *</label>
                            <input type="text" class="form-control" name="identificacao" required 
                                   placeholder="Ex: Caminhão ABC-1234, Máquina XYZ, etc.">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Data *</label>
                            <input type="date" class="form-control" name="data" required 
                                   value="{{ now.strftime('%Y-%m-%d') }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Horímetro</label>
                            <input type="number" step="0.1" class="form-control" name="horimetro" 
                                   placeholder="Horas de uso do equipamento">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Nível de Óleo *</label>
                            <select class="form-select" name="nivel_oleo" required>
                                <option value="ADEQUADO">Adequado</option>
                                <option value="BAIXO">Baixo</option>
                                <option value="CRÍTICO">Crítico</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Itens do Checklist</label>
                            <textarea class="form-control" name="itens_checklist" rows="3" 
                                      placeholder="Lista de itens verificados no checklist..."></textarea>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Observações</label>
                            <textarea class="form-control" name="observacoes" rows="2" 
                                      placeholder="Observações adicionais..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Editar Checklist -->
<div class="modal fade" id="editarChecklistModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar Checklist</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="formEditarChecklist">
                <input type="hidden" id="editar_id">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Identificação *</label>
                            <input type="text" class="form-control" id="editar_identificacao" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Data *</label>
                            <input type="date" class="form-control" id="editar_data" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Horímetro</label>
                            <input type="number" step="0.1" class="form-control" id="editar_horimetro">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Nível de Óleo *</label>
                            <select class="form-select" id="editar_nivel_oleo" required>
                                <option value="ADEQUADO">Adequado</option>
                                <option value="BAIXO">Baixo</option>
                                <option value="CRÍTICO">Crítico</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Itens do Checklist</label>
                            <textarea class="form-control" id="editar_itens_checklist" rows="3"></textarea>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Observações</label>
                            <textarea class="form-control" id="editar_observacoes" rows="2"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarEdicao()">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Detalhes -->
<div class="modal fade" id="detalhesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalhes do Checklist</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detalhesConteudo">
                <!-- Conteúdo será preenchido via JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" onclick="imprimirChecklist()">
                    <i class="bi bi-printer"></i> Imprimir
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Variáveis globais
let checklists = [];

// Carregar dados ao iniciar
document.addEventListener('DOMContentLoaded', function() {
    carregarChecklists();
    configurarFiltros();
    configurarFormularios();
});

function carregarChecklists() {
    fetch('/api/checklists')
        .then(response => response.json())
        .then(data => {
            if (data.checklists && Array.isArray(data.checklists)) {
                checklists = data.checklists;
            } else {
                checklists = [];
            }
            aplicarFiltros();
        })
        .catch(error => {
            console.error('Erro ao carregar checklists:', error);
            checklists = [];
            aplicarFiltros();
        });
}

function configurarFiltros() {
    // Filtro de identificação
    document.getElementById('filtroIdentificacao').addEventListener('input', aplicarFiltros);
    
    // Filtro de nível de óleo
    document.getElementById('filtroNivelOleo').addEventListener('change', aplicarFiltros);
    
    // Filtro de data
    document.getElementById('filtroData').addEventListener('change', aplicarFiltros);
}

function configurarFormularios() {
    // Formulário de novo checklist
    document.getElementById('formNovoChecklist').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        const dados = {
            identificacao: formData.get('identificacao'),
            data: formData.get('data'),
            horimetro: formData.get('horimetro') ? parseFloat(formData.get('horimetro')) : null,
            nivel_oleo: formData.get('nivel_oleo'),
            observacoes: formData.get('observacoes') || '',
            itens_checklist: formData.get('itens_checklist') || ''
        };

        fetch('/api/checklists', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(dados)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('novoChecklistModal')).hide();
                this.reset();
                showAlert('Checklist cadastrado com sucesso!', 'success');
                carregarChecklists();
            } else {
                showAlert('Erro ao cadastrar checklist: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Erro ao cadastrar checklist', 'danger');
        });
    });
}

function aplicarFiltros() {
    const filtroIdentificacao = document.getElementById('filtroIdentificacao').value.toLowerCase();
    const filtroNivelOleo = document.getElementById('filtroNivelOleo').value;
    const filtroData = document.getElementById('filtroData').value;
    
    let dadosFiltrados = checklists.filter(checklist => {
        // Filtro por identificação
        if (filtroIdentificacao && !checklist.identificacao.toLowerCase().includes(filtroIdentificacao)) {
            return false;
        }
        
        // Filtro por nível de óleo
        if (filtroNivelOleo !== 'todos' && checklist.nivel_oleo !== filtroNivelOleo) {
            return false;
        }
        
        // Filtro por data
        if (filtroData && checklist.data !== filtroData) {
            return false;
        }
        
        return true;
    });
    
    atualizarTabela(dadosFiltrados);
}

function limparFiltros() {
    document.getElementById('filtroIdentificacao').value = '';
    document.getElementById('filtroNivelOleo').value = 'todos';
    document.getElementById('filtroData').value = '';
    
    aplicarFiltros();
}

function atualizarTabela(dados) {
    const tbody = document.getElementById('corpoTabela');
    
    if (dados.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-4">
                    <i class="bi bi-inbox"></i>
                    <p class="text-muted">Nenhum checklist encontrado com os filtros aplicados.</p>
                </td>
            </tr>
        `;
        return;
    }

    let html = '';
    dados.forEach(checklist => {
        const horimetro = checklist.horimetro ? checklist.horimetro.toFixed(1) : '-';
        
        html += `
            <tr id="row-${checklist.id}">
                <td>${checklist.id}</td>
                <td>${checklist.identificacao}</td>
                <td>${checklist.data}</td>
                <td class="text-end">${horimetro}</td>
                <td class="text-center">
                    <span class="badge 
                        ${checklist.nivel_oleo === 'ADEQUADO' ? 'bg-success' : 
                          checklist.nivel_oleo === 'BAIXO' ? 'bg-warning' : 'bg-danger'}">
                        ${checklist.nivel_oleo}
                    </span>
                </td>
                <td class="text-center">
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-info" onclick="detalhesChecklist(${checklist.id})" title="Detalhes">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-outline-primary" onclick="editarChecklist(${checklist.id})" title="Editar">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="excluirChecklist(${checklist.id})" title="Excluir">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });

    tbody.innerHTML = html;
}

function editarChecklist(id) {
    fetch(`/api/checklists/${id}`)
        .then(response => response.json())
        .then(checklist => {
            if (checklist.error) {
                showAlert('Erro ao carregar checklist: ' + checklist.error, 'danger');
                return;
            }
            
            // Preencher o formulário de edição
            document.getElementById('editar_id').value = checklist.id;
            document.getElementById('editar_identificacao').value = checklist.identificacao;
            document.getElementById('editar_data').value = checklist.data;
            document.getElementById('editar_horimetro').value = checklist.horimetro || '';
            document.getElementById('editar_nivel_oleo').value = checklist.nivel_oleo;
            document.getElementById('editar_itens_checklist').value = checklist.itens_checklist || '';
            document.getElementById('editar_observacoes').value = checklist.observacoes || '';
            
            // Abrir o modal
            new bootstrap.Modal(document.getElementById('editarChecklistModal')).show();
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Erro ao carregar dados do checklist', 'danger');
        });
}

function salvarEdicao() {
    const id = document.getElementById('editar_id').value;
    
    const dados = {
        identificacao: document.getElementById('editar_identificacao').value,
        data: document.getElementById('editar_data').value,
        horimetro: document.getElementById('editar_horimetro').value ? 
                  parseFloat(document.getElementById('editar_horimetro').value) : null,
        nivel_oleo: document.getElementById('editar_nivel_oleo').value,
        observacoes: document.getElementById('editar_observacoes').value || '',
        itens_checklist: document.getElementById('editar_itens_checklist').value || ''
    };

    fetch(`/api/checklists/${id}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(dados)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('editarChecklistModal')).hide();
            showAlert('Checklist atualizado com sucesso!', 'success');
            carregarChecklists();
        } else {
            showAlert('Erro ao atualizar checklist: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Erro ao atualizar checklist', 'danger');
    });
}

function detalhesChecklist(id) {
    fetch(`/api/checklists/${id}`)
        .then(response => response.json())
        .then(checklist => {
            if (checklist.error) {
                showAlert('Erro ao carregar detalhes: ' + checklist.error, 'danger');
                return;
            }
            
            const horimetro = checklist.horimetro ? checklist.horimetro.toFixed(1) + ' horas' : 'Não informado';
            const nivelOleoClass = checklist.nivel_oleo === 'ADEQUADO' ? 'success' : 
                                  checklist.nivel_oleo === 'BAIXO' ? 'warning' : 'danger';
            
            const html = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header bg-primary text-white">
                                <i class="bi bi-info-circle"></i> Informações do Checklist
                            </div>
                            <div class="card-body">
                                <div class="row mb-2">
                                    <div class="col-5"><strong>ID:</strong></div>
                                    <div class="col-7">${checklist.id}</div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-5"><strong>Identificação:</strong></div>
                                    <div class="col-7">${checklist.identificacao}</div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-5"><strong>Data:</strong></div>
                                    <div class="col-7">${checklist.data}</div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-5"><strong>Horímetro:</strong></div>
                                    <div class="col-7">${horimetro}</div>
                                </div>
                                <div class="row">
                                    <div class="col-5"><strong>Nível de Óleo:</strong></div>
                                    <div class="col-7">
                                        <span class="badge bg-${nivelOleoClass}">${checklist.nivel_oleo}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                ${checklist.itens_checklist ? `
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <i class="bi bi-list-check"></i> Itens do Checklist
                            </div>
                            <div class="card-body">
                                <pre style="white-space: pre-wrap;">${checklist.itens_checklist}</pre>
                            </div>
                        </div>
                    </div>
                </div>
                ` : ''}
                
                ${checklist.observacoes ? `
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-secondary text-white">
                                <i class="bi bi-chat"></i> Observações
                            </div>
                            <div class="card-body">
                                <pre style="white-space: pre-wrap;">${checklist.observacoes}</pre>
                            </div>
                        </div>
                    </div>
                </div>
                ` : ''}
                
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-light">
                                <i class="bi bi-calendar"></i> Datas
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-6">
                                        <strong>Data do Checklist:</strong> ${checklist.data}
                                    </div>
                                    <div class="col-6">
                                        <strong>Data de Registro:</strong> ${checklist.data_registro ? checklist.data_registro.split(' ')[0] : '-'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('detalhesConteudo').innerHTML = html;
            new bootstrap.Modal(document.getElementById('detalhesModal')).show();
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Erro ao carregar detalhes do checklist', 'danger');
        });
}

function excluirChecklist(id) {
    if (confirm('Tem certeza que deseja excluir este checklist?')) {
        fetch(`/api/checklists/${id}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Checklist excluído com sucesso!', 'success');
                carregarChecklists();
            } else {
                showAlert('Erro ao excluir checklist: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Erro ao excluir checklist', 'danger');
        });
    }
}

function imprimirChecklist() {
    window.print();
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.navbar').nextElementSibling);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 3000);
}
</script>

<style>
.grafico-container {
    position: relative;
    height: 300px;
}

.card {
    transition: transform 0.2s;
}

.card:hover {
    transform: translateY(-2px);
}

.table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.1);
}

.badge {
    font-size: 0.85em;
}

@media print {
    .no-print {
        display: none !important;
    }
    
    .modal-dialog {
        max-width: none;
        margin: 0;
    }
    
    .modal-content {
        border: none;
        height: auto;
        min-height: 100vh;
    }
}
</style>
{% endblock %}