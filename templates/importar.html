{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="card-header bg-primary text-white">
        <i class="bi bi-upload"></i> Importar Dados
    </div>
    <div class="card-body">
        <form id="importForm" method="POST" enctype="multipart/form-data" action="/importar">
            <div class="mb-3">
                <label for="file" class="form-label">Selecione o arquivo:</label>
                <input class="form-control" type="file" id="file" name="file" required
                       onchange="previewFile(this)">
                <div class="form-text">Formatos aceitos: .xlsx ou .csv</div>
            </div>
            
            <div id="previewSection" class="mb-3 d-none">
                <h5>Pré-visualização</h5>
                <div class="table-responsive">
                    <table class="table table-bordered" id="previewTable">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-upload"></i> Importar
            </button>
        </form>
    </div>
</div>

<script>
function previewFile(input) {
    const file = input.files[0];
    if (!file) return;
    
    const formData = new FormData();
    formData.append('file', file);
    
    fetch('/preview-import', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Erro: ' + data.error);
            return;
        }
        
        const previewSection = document.getElementById('previewSection');
        const previewTable = document.getElementById('previewTable');
        
        // Limpar tabela
        previewTable.querySelector('thead').innerHTML = '';
        previewTable.querySelector('tbody').innerHTML = '';
        
        // Adicionar cabeçalhos
        const headerRow = document.createElement('tr');
        data.columns.forEach(col => {
            const th = document.createElement('th');
            th.textContent = col;
            headerRow.appendChild(th);
        });
        previewTable.querySelector('thead').appendChild(headerRow);
        
        // Adicionar dados
        data.preview.forEach(row => {
            const tr = document.createElement('tr');
            data.columns.forEach(col => {
                const td = document.createElement('td');
                td.textContent = row[col] !== null ? row[col] : '';
                tr.appendChild(td);
            });
            previewTable.querySelector('tbody').appendChild(tr);
        });
        
        previewSection.classList.remove('d-none');
    })
    .catch(error => {
        console.error('Error:', error);
    });
}
</script>
{% endblock %}