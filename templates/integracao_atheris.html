{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="card-header bg-info text-white">
        <i class="bi bi-plug"></i> Integração Atheris - Cadastro Manual
    </div>
    <div class="card-body">
        <form method="POST" action="/integracao-atheris" id="formAtheris">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Data *</label>
                    <input type="date" class="form-control" name="data" required 
                           value="{{ now.strftime('%Y-%m-%d') }}" max="{{ now.strftime('%Y-%m-%d') }}">
                </div>
                
                <div class="col-md-6">
                    <label class="form-label">Placa *</label>
                    <input type="text" class="form-control" name="placa" required 
                           pattern="[A-Za-z]{3}[0-9][A-Za-z0-9][0-9]{2}" 
                           title="Formato: ABC1D23 ou ABC1234" placeholder="ABC1D23">
                </div>
                
                <div class="col-md-6">
                    <label class="form-label">Responsável</label>
                    <input type="text" class="form-control" name="responsavel" placeholder="Nome do responsável">
                </div>
                
                <div class="col-md-6">
                    <label class="form-label">Centro de Custo</label>
                    <input type="text" class="form-control" name="centro_custo" placeholder="Centro de custo">
                </div>
                
                <div class="col-md-6">
                    <label class="form-label">Posto</label>
                    <input type="text" class="form-control" name="posto" placeholder="Nome do posto (ex: Posto Shell, Posto Ipiranga)">
                </div>
                
                <div class="col-md-6">
                    <label class="form-label">Combustível *</label>
                    <select class="form-select" name="combustivel" id="combustivel" required>
                        <option value="">Selecione...</option>
                        {% for preco in precos %}
                            <option value="{{ preco.combustivel }}" 
                                    data-preco="{{ preco.preco }}">
                                {{ preco.combustivel }} (R$ {{ "%.3f"|format(preco.preco) }})
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-4">
                    <label class="form-label">Litros *</label>
                    <input type="number" step="0.001" min="0.001" class="form-control" 
                           name="litros" id="litros" required placeholder="Ex: 45.500">
                </div>
                
                <div class="col-md-4">
                    <label class="form-label">Preço por Litro (R$) *</label>
                    <input type="number" step="0.001" min="0.001" class="form-control" 
                           name="custo_por_litro" id="custo_por_litro" required placeholder="Ex: 5.890">
                </div>
                
                <div class="col-md-4">
                    <label class="form-label">Desconto (R$)</label>
                    <input type="number" step="0.01" min="0" class="form-control" 
                           name="desconto" id="desconto" value="0" placeholder="Ex: 10.50">
                </div>
                
                <div class="col-md-4">
                    <label class="form-label">Odômetro (KM)</label>
                    <input type="number" step="0.1" min="0" class="form-control" 
                           name="odometro" id="odometro" placeholder="Ex: 12500.5">
                </div>
                
                <div class="col-md-4">
                    <label class="form-label">Valor Total</label>
                    <div class="input-group">
                        <span class="input-group-text">R$</span>
                        <input type="text" class="form-control bg-light" id="valor_total" 
                               readonly value="0,00" style="font-weight: bold;">
                    </div>
                </div>
                
                <div class="col-12 mt-4">
                    <div class="card bg-light">
                        <div class="card-body p-3">
                            <div class="row">
                                <div class="col-md-4">
                                    <strong>Valor Bruto:</strong> 
                                    <span id="valor_bruto">R$ 0,00</span>
                                </div>
                                <div class="col-md-4">
                                    <strong>Desconto:</strong> 
                                    <span id="display_desconto">R$ 0,00</span>
                                </div>
                                <div class="col-md-4">
                                    <strong>Valor Líquido:</strong> 
                                    <span id="valor_liquido" class="fw-bold text-success">R$ 0,00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-12 mt-3">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="bi bi-save"></i> Registrar Abastecimento
                    </button>
                    <button type="reset" class="btn btn-outline-secondary ms-2">
                        <i class="bi bi-arrow-clockwise"></i> Limpar
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const combustivelSelect = document.getElementById('combustivel');
    const custoPorLitroInput = document.getElementById('custo_por_litro');
    const litrosInput = document.getElementById('litros');
    const descontoInput = document.getElementById('desconto');
    const valorTotalInput = document.getElementById('valor_total');
    const valorBrutoSpan = document.getElementById('valor_bruto');
    const displayDescontoSpan = document.getElementById('display_desconto');
    const valorLiquidoSpan = document.getElementById('valor_liquido');
    
    // Formatar valor em Real
    function formatarReal(valor) {
        return 'R$ ' + valor.toLocaleString('pt-BR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
    
    // Atualiza preço quando muda o combustível
    combustivelSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.value) {
            const preco = selectedOption.getAttribute('data-preco');
            custoPorLitroInput.value = parseFloat(preco).toFixed(3);
            calcularValores();
        }
    });
    
    // Calcula valores quando mudam litros, preço ou desconto
    [litrosInput, custoPorLitroInput, descontoInput].forEach(input => {
        input.addEventListener('input', calcularValores);
    });
    
    function calcularValores() {
        const litros = parseFloat(litrosInput.value) || 0;
        const precoLitro = parseFloat(custoPorLitroInput.value) || 0;
        const desconto = parseFloat(descontoInput.value) || 0;
        
        const valorBruto = litros * precoLitro;
        const valorLiquido = valorBruto - desconto;
        
        // Atualizar displays
        valorBrutoSpan.textContent = formatarReal(valorBruto);
        displayDescontoSpan.textContent = formatarReal(desconto);
        valorLiquidoSpan.textContent = formatarReal(valorLiquido);
        valorTotalInput.value = valorLiquido.toLocaleString('pt-BR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
    
    // Validação do formulário
    document.getElementById('formAtheris').addEventListener('submit', function(e) {
        const litros = parseFloat(litrosInput.value);
        const precoLitro = parseFloat(custoPorLitroInput.value);
        
        if (litros <= 0) {
            alert('A quantidade de litros deve ser maior que zero');
            e.preventDefault();
            return;
        }
        
        if (precoLitro <= 0) {
            alert('O preço por litro deve ser maior que zero');
            e.preventDefault();
            return;
        }
        
        const desconto = parseFloat(descontoInput.value) || 0;
        const valorBruto = litros * precoLitro;
        
        if (desconto > valorBruto) {
            alert('O desconto não pode ser maior que o valor bruto');
            e.preventDefault();
        }
    });
    
    // Calcular valores iniciais
    calcularValores();
});
</script>
{% endblock %}