{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
        <div>
            <i class="bi bi-tools"></i> Controle de Manutenções
        </div>
        <div>
            <button class="btn btn-light btn-sm me-2" onclick="abrirModalFiltrosImpressao()" title="Imprimir Relatório com Filtros">
                <i class="bi bi-printer"></i> Relatório com Filtros
            </button>
            <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#novaManutencaoModal">
                <i class="bi bi-plus-circle"></i> Nova Manutenção
            </button>
        </div>
    </div>
    <div class="card-body">
        <!-- Filtros -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" id="filtroIdentificacao" class="form-control" placeholder="Filtrar por identificação...">
                </div>
            </div>
            <div class="col-md-2">
                <select id="filtroStatus" class="form-select">
                    <option value="todos">Todos os status</option>
                    <option value="aberto">Abertas</option>
                    <option value="finalizado">Finalizadas</option>
                </select>
            </div>
            <div class="col-md-2">
                <select id="filtroTipo" class="form-select">
                    <option value="todos">Todos os tipos</option>
                    <option value="corretiva">Corretiva</option>
                    <option value="preventiva">Preventiva</option>
                </select>
            </div>
            <div class="col-md-2">
                <select id="filtroFrota" class="form-select">
                    <option value="todos">Todas as frotas</option>
                    <option value="apoio">Apoio</option>
                    <option value="maquinas">Máquinas</option>
                    <option value="equipamento">Equipamento</option>
                </select>
            </div>
            <div class="col-md-3">
                <select id="filtroPagamento" class="form-select">
                    <option value="todos">Todas as formas de pagamento</option>
                    <option value="dinheiro">Dinheiro</option>
                    <option value="pix">PIX</option>
                    <option value="cartao_credito">Cartão de Crédito</option>
                    <option value="cartao_debito">Cartão de Débito</option>
                    <option value="transferencia">Transferência</option>
                    <option value="boleto">Boleto</option>
                </select>
            </div>
        </div>

        <!-- Cards de Resumo -->
        <div class="row mb-4">
            <div class="col-md-2">
                <div class="card text-center bg-primary text-white">
                    <div class="card-body">
                        <h5><i class="bi bi-tools"></i> Total</h5>
                        <h3 id="total-manutencoes">{{ total_manutencoes }}</h3>
                        <small>Manutenções</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center bg-warning text-dark">
                    <div class="card-body">
                        <h5><i class="bi bi-clock"></i> Abertas</h5>
                        <h3 id="total-abertas">{{ manutencoes_abertas }}</h3>
                        <small>Em andamento</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center bg-success text-white">
                    <div class="card-body">
                        <h5><i class="bi bi-check-circle"></i> Finalizadas</h5>
                        <h3 id="total-finalizadas">{{ manutencoes_finalizadas }}</h3>
                        <small>Concluídas</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-danger text-white">
                    <div class="card-body">
                        <h5><i class="bi bi-currency-dollar"></i> Valor Total</h5>
                        <h3 id="valor-total">R$ {{ "%.2f"|format(valor_total) }}</h3>
                        <small>Total em manutenções</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-info text-white">
                    <div class="card-body">
                        <h5><i class="bi bi-calendar-check"></i> Próximas</h5>
                        <h3 id="proximas-liberacao">0</h3>
                        <small>Próximas da liberação</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabela de Manutenções -->
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="tabelaManutencoes">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Identificação</th>
                        <th>Tipo</th>
                        <th>Frota</th>
                        <th>Descrição</th>
                        <th>Fornecedor</th>
                        <th class="text-end">Valor</th>
                        <th>Pagamento</th>
                        <th class="text-center">Status</th>
                        <th class="text-center">Ações</th>
                    </tr>
                </thead>
                <tbody id="corpoTabela">
                    {% for manutencao in manutencoes %}
                    <tr id="row-{{ manutencao.id }}">
                        <td>{{ manutencao.id }}</td>
                        <td>{{ manutencao.identificacao }}</td>
                        <td>{{ 'Corretiva' if manutencao.tipo == 'corretiva' else 'Preventiva' }}</td>
                        <td>
                            {% if manutencao.frota == 'apoio' %}Apoio
                            {% elif manutencao.frota == 'maquinas' %}Máquinas
                            {% elif manutencao.frota == 'equipamento' %}Equipamento
                            {% else %}{{ manutencao.frota }}{% endif %}
                        </td>
                        <td>{{ manutencao.descricao[:50] }}{% if manutencao.descricao|length > 50 %}...{% endif %}</td>
                        <td>{{ manutencao.fornecedor or '-' }}</td>
                        <td class="text-end">R$ {{ "%.2f"|format(manutencao.valor) }}</td>
                        <td>
                            {% if manutencao.forma_pagamento %}
                                {{ manutencao.forma_pagamento }}{% if manutencao.parcelas and manutencao.parcelas > 1 %} ({{ manutencao.parcelas }}x){% endif %}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <span class="badge {% if manutencao.finalizada %}bg-success{% else %}bg-warning{% endif %}">
                                {{ 'Finalizada' if manutencao.finalizada else 'Em Aberto' }}
                            </span>
                        </td>
                        <td class="text-center">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-info" onclick="detalhesManutencao({{ manutencao.id }})" title="Detalhes">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-outline-primary" onclick="editarManutencao({{ manutencao.id }})" title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="excluirManutencao({{ manutencao.id }})" title="Excluir">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="10" class="text-center py-4">
                            <i class="bi bi-inbox"></i>
                            <p class="text-muted">Nenhuma manutenção cadastrada.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Nova Manutenção -->
<div class="modal fade" id="novaManutencaoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nova Manutenção</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="formNovaManutencao">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Tipo de Manutenção *</label>
                            <select class="form-select" name="tipo" required>
                                <option value="">Selecione...</option>
                                <option value="corretiva">Corretiva</option>
                                <option value="preventiva">Preventiva</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Tipo de Frota *</label>
                            <select class="form-select" name="frota" required>
                                <option value="">Selecione...</option>
                                <option value="apoio">Apoio</option>
                                <option value="maquinas">Máquinas</option>
                                <option value="equipamento">Equipamento</option>
                            </select>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Identificação *</label>
                            <input type="text" class="form-control" name="identificacao" required 
                                   placeholder="Ex: Caminhão ABC-1234, Máquina XYZ, etc.">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Data de Abertura *</label>
                            <input type="date" class="form-control" name="data_abertura" required 
                                   value="{{ now.strftime('%Y-%m-%d') }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Previsão de Conclusão</label>
                            <input type="date" class="form-control" name="previsao_conclusao">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Prazo para Liberação (dias úteis)</label>
                            <input type="number" min="0" class="form-control" name="prazo_liberacao" 
                                   placeholder="Ex: 5">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Forma de Pagamento</label>
                            <select class="form-select" name="forma_pagamento">
                                <option value="">Selecione...</option>
                                <option value="dinheiro">Dinheiro</option>
                                <option value="pix">PIX</option>
                                <option value="cartao_credito">Cartão de Crédito</option>
                                <option value="cartao_debito">Cartão de Débito</option>
                                <option value="transferencia">Transferência</option>
                                <option value="boleto">Boleto</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Parcelas</label>
                            <input type="number" min="1" max="24" class="form-control" name="parcelas" 
                                   placeholder="Nº de parcelas" value="1">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Manutenção a Ser Realizada *</label>
                            <textarea class="form-control" name="descricao" rows="3" required 
                                      placeholder="Descreva detalhadamente a manutenção necessária..."></textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Fornecedor</label>
                            <input type="text" class="form-control" name="fornecedor" 
                                   placeholder="Nome do fornecedor">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Valor Orçado (R$)</label>
                            <input type="number" step="0.01" min="0" class="form-control" 
                                   name="valor" placeholder="0,00">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Observações</label>
                            <textarea class="form-control" name="observacoes" rows="2" 
                                      placeholder="Informações adicionais..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Editar Manutenção -->
<div class="modal fade" id="editarManutencaoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar Manutenção</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="formEditarManutencao">
                <input type="hidden" id="editar_id">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Tipo de Manutenção *</label>
                            <select class="form-select" id="editar_tipo" required>
                                <option value="">Selecione...</option>
                                <option value="corretiva">Corretiva</option>
                                <option value="preventiva">Preventiva</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Tipo de Frota *</label>
                            <select class="form-select" id="editar_frota" required>
                                <option value="">Selecione...</option>
                                <option value="apoio">Apoio</option>
                                <option value="maquinas">Máquinas</option>
                                <option value="equipamento">Equipamento</option>
                            </select>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Identificação *</label>
                            <input type="text" class="form-control" id="editar_identificacao" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Data de Abertura *</label>
                            <input type="date" class="form-control" id="editar_data_abertura" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Data de Conclusão</label>
                            <input type="date" class="form-control" id="editar_data_conclusao">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Previsão de Conclusão</label>
                            <input type="date" class="form-control" id="editar_previsao_conclusao">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Prazo para Liberação (dias úteis)</label>
                            <input type="number" min="0" class="form-control" id="editar_prazo_liberacao">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Forma de Pagamento</label>
                            <select class="form-select" id="editar_forma_pagamento">
                                <option value="">Selecione...</option>
                                <option value="dinheiro">Dinheiro</option>
                                <option value="pix">PIX</option>
                                <option value="cartao_credito">Cartão de Crédito</option>
                                <option value="cartao_debito">Cartão de Débito</option>
                                <option value="transferencia">Transferência</option>
                                <option value="boleto">Boleto</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Parcelas</label>
                            <input type="number" min="1" max="24" class="form-control" id="editar_parcelas" value="1">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Manutenção a Ser Realizada *</label>
                            <textarea class="form-control" id="editar_descricao" rows="3" required></textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Fornecedor</label>
                            <input type="text" class="form-control" id="editar_fornecedor">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Valor Orçado (R$)</label>
                            <input type="number" step="0.01" min="0" class="form-control" id="editar_valor">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Observações</label>
                            <textarea class="form-control" id="editar_observacoes" rows="2"></textarea>
                        </div>
                        <div class="col-12">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="editar_finalizada">
                                <label class="form-check-label" for="editar_finalizada">Manutenção Finalizada</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarEdicao()">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Detalhes/Impressão -->
<div class="modal fade" id="detalhesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalhes da Manutenção</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detalhesConteudo">
                <!-- Conteúdo será preenchido via JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" onclick="imprimirManutencao()">
                    <i class="bi bi-printer"></i> Imprimir
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Filtros para Impressão -->
<div class="modal fade" id="filtrosImpressaoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Filtros para Relatório de Impressão</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Identificação</label>
                        <input type="text" class="form-control" id="filtroImpressaoIdentificacao" placeholder="Filtrar por identificação...">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="filtroImpressaoStatus">
                            <option value="todos">Todos os status</option>
                            <option value="aberto">Abertas</option>
                            <option value="finalizado">Finalizadas</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Tipo</label>
                        <select class="form-select" id="filtroImpressaoTipo">
                            <option value="todos">Todos os tipos</option>
                            <option value="corretiva">Corretiva</option>
                            <option value="preventiva">Preventiva</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Frota</label>
                        <select class="form-select" id="filtroImpressaoFrota">
                            <option value="todos">Todas as frotas</option>
                            <option value="apoio">Apoio</option>
                            <option value="maquinas">Máquinas</option>
                            <option value="equipamento">Equipamento</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Forma de Pagamento</label>
                        <select class="form-select" id="filtroImpressaoPagamento">
                            <option value="todos">Todas as formas</option>
                            <option value="dinheiro">Dinheiro</option>
                            <option value="pix">PIX</option>
                            <option value="cartao_credito">Cartão de Crédito</option>
                            <option value="cartao_debito">Cartão de Débito</option>
                            <option value="transferencia">Transferência</option>
                            <option value="boleto">Boleto</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Ordenar por</label>
                        <select class="form-select" id="filtroImpressaoOrdenar">
                            <option value="data_abertura">Data de Abertura</option>
                            <option value="valor">Valor</option>
                            <option value="identificacao">Identificação</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Direção da Ordenação</label>
                        <select class="form-select" id="filtroImpressaoOrdenarDirecao">
                            <option value="desc">Decrescente</option>
                            <option value="asc">Crescente</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Período - Data Início</label>
                        <input type="date" class="form-control" id="filtroImpressaoDataInicio">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Período - Data Fim</label>
                        <input type="date" class="form-control" id="filtroImpressaoDataFim">
                    </div>
                    <div class="col-12">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="filtroImpressaoUsarFiltrosAtuais">
                            <label class="form-check-label" for="filtroImpressaoUsarFiltrosAtuais">
                                Usar filtros atuais da tela
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="imprimirComFiltros()">
                    <i class="bi bi-printer"></i> Gerar Relatório
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Variáveis globais
let manutencoes = [];

// Carregar dados ao iniciar
document.addEventListener('DOMContentLoaded', function() {
    carregarManutencoes();
    configurarFiltros();
    configurarFormularios();
});

function carregarManutencoes() {
    fetch('/api/manutencoes')
        .then(response => response.json())
        .then(data => {
            console.log('Dados recebidos:', data); // Debug
            if (data.manutencoes && Array.isArray(data.manutencoes)) {
                manutencoes = data.manutencoes;
                
                // Atualizar estatísticas do dashboard
                if (data.estatisticas) {
                    document.getElementById('total-manutencoes').textContent = data.estatisticas.total;
                    document.getElementById('total-abertas').textContent = data.estatisticas.abertas;
                    document.getElementById('total-finalizadas').textContent = data.estatisticas.finalizadas;
                    document.getElementById('valor-total').textContent = 
                        'R$ ' + data.estatisticas.valor_total.toLocaleString('pt-BR', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        });
                    
                    // Calcular manutenções próximas da liberação
                    const hoje = new Date();
                    const proximas = manutencoes.filter(m => {
                        if (m.finalizada || !m.prazo_liberacao || !m.data_abertura) return false;
                        
                        const dataAbertura = new Date(m.data_abertura);
                        const dataLimite = new Date(dataAbertura);
                        dataLimite.setDate(dataLimite.getDate() + m.prazo_liberacao);
                        
                        const diffTime = dataLimite - hoje;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        
                        return diffDays <= 3 && diffDays >= 0;
                    });
                    
                    document.getElementById('proximas-liberacao').textContent = proximas.length;
                }
            } else {
                console.error('Estrutura de dados inválida:', data);
                manutencoes = [];
            }
            aplicarFiltros();
        })
        .catch(error => {
            console.error('Erro ao carregar manutenções:', error);
            manutencoes = [];
            aplicarFiltros();
        });
}

function configurarFiltros() {
    // Filtro de identificação
    document.getElementById('filtroIdentificacao').addEventListener('input', aplicarFiltros);
    
    // Filtro de status
    document.getElementById('filtroStatus').addEventListener('change', aplicarFiltros);
    
    // Filtro de tipo
    document.getElementById('filtroTipo').addEventListener('change', aplicarFiltros);
    
    // Filtro de frota
    document.getElementById('filtroFrota').addEventListener('change', aplicarFiltros);
    
    // Filtro de forma de pagamento
    document.getElementById('filtroPagamento').addEventListener('change', aplicarFiltros);
}

function configurarFormularios() {
    // Formulário de nova manutenção
    document.getElementById('formNovaManutencao').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        const dados = {
            identificacao: formData.get('identificacao'),
            tipo: formData.get('tipo'),
            frota: formData.get('frota'),
            descricao: formData.get('descricao'),
            fornecedor: formData.get('fornecedor'),
            valor: parseFloat(formData.get('valor')) || 0,
            data_abertura: formData.get('data_abertura'),
            previsao_conclusao: formData.get('previsao_conclusao') || '',
            data_conclusao: formData.get('data_conclusao') || '',
            observacoes: formData.get('observacoes') || '',
            finalizada: false,
            prazo_liberacao: formData.get('prazo_liberacao') ? parseInt(formData.get('prazo_liberacao')) : null,
            forma_pagamento: formData.get('forma_pagamento') || '',
            parcelas: formData.get('parcelas') ? parseInt(formData.get('parcelas')) : 1
        };

        fetch('/api/manutencoes', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(dados)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('novaManutencaoModal')).hide();
                this.reset();
                showAlert('Manutenção cadastrada com sucesso!', 'success');
                carregarManutencoes(); // Recarregar dados
            } else {
                showAlert('Erro ao cadastrar manutenção: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Erro ao cadastrar manutenção', 'danger');
        });
    });
}

function aplicarFiltros() {
    const filtroIdentificacao = document.getElementById('filtroIdentificacao').value.toLowerCase();
    const filtroStatus = document.getElementById('filtroStatus').value;
    const filtroTipo = document.getElementById('filtroTipo').value;
    const filtroFrota = document.getElementById('filtroFrota').value;
    const filtroPagamento = document.getElementById('filtroPagamento').value;
    
    let dadosFiltrados = manutencoes.filter(manutencao => {
        // Filtro por identificação
        if (filtroIdentificacao && !manutencao.identificacao.toLowerCase().includes(filtroIdentificacao)) {
            return false;
        }
        
        // Filtro por status
        if (filtroStatus !== 'todos') {
            if (filtroStatus === 'aberto' && manutencao.finalizada) return false;
            if (filtroStatus === 'finalizado' && !manutencao.finalizada) return false;
        }
        
        // Filtro por tipo
        if (filtroTipo !== 'todos' && manutencao.tipo !== filtroTipo) {
            return false;
        }
        
        // Filtro por frota
        if (filtroFrota !== 'todos' && manutencao.frota !== filtroFrota) {
            return false;
        }
        
        // Filtro por forma de pagamento
        if (filtroPagamento !== 'todos' && manutencao.forma_pagamento !== filtroPagamento) {
            return false;
        }
        
        return true;
    });
    
    atualizarTabela(dadosFiltrados);
}

function atualizarTabela(dados) {
    const tbody = document.getElementById('corpoTabela');
    console.log('Atualizando tabela com:', dados); // Debug
    
    if (!dados || dados.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="10" class="text-center py-4">
                    <i class="bi bi-inbox"></i>
                    <p class="text-muted">Nenhuma manutenção encontrada com os filtros aplicados.</p>
                </td>
            </tr>
        `;
        return;
    }

    let html = '';
    dados.forEach(manutencao => {
        // Adicionar verificações para evitar erros
        const valor = manutencao.valor || 0;
        const valorFormatado = 'R$ ' + valor.toLocaleString('pt-BR', { 
            minimumFractionDigits: 2, 
            maximumFractionDigits: 2 
        });
        
        const tipoFormatado = manutencao.tipo === 'corretiva' ? 'Corretiva' : 'Preventiva';
        
        const frotaFormatada = {
            'apoio': 'Apoio',
            'maquinas': 'Máquinas',
            'equipamento': 'Equipamento'
        }[manutencao.frota] || manutencao.frota;
        
        // Verificar se as propriedades existem antes de acessá-las
        const formaPagamento = manutencao.forma_pagamento || '';
        const parcelas = manutencao.parcelas || 0;
        
        const pagamentoFormatado = formaPagamento ? 
            `${formaPagamento}${parcelas > 1 ? ` (${parcelas}x)` : ''}` : 
            '-';
        
        const descricao = manutencao.descricao || '';
        const descricaoTruncada = descricao.length > 50 ? 
            descricao.substring(0, 50) + '...' : descricao;
        
        html += `
            <tr id="row-${manutencao.id}">
                <td>${manutencao.id}</td>
                <td>${manutencao.identificacao || '-'}</td>
                <td>${tipoFormatado}</td>
                <td>${frotaFormatada}</td>
                <td>${descricaoTruncada}</td>
                <td>${manutencao.fornecedor || '-'}</td>
                <td class="text-end">${valorFormatado}</td>
                <td>${pagamentoFormatado}</td>
                <td class="text-center">
                    <span class="badge ${manutencao.finalizada ? 'bg-success' : 'bg-warning'}">
                        ${manutencao.finalizada ? 'Finalizada' : 'Em Aberto'}
                    </span>
                </td>
                <td class="text-center">
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-info" onclick="detalhesManutencao(${manutencao.id})" title="Detalhes">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-outline-primary" onclick="editarManutencao(${manutencao.id})" title="Editar">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="excluirManutencao(${manutencao.id})" title="Excluir">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });

    tbody.innerHTML = html;
}

function editarManutencao(id) {
    fetch(`/api/manutencoes/${id}`)
        .then(response => response.json())
        .then(manutencao => {
            if (manutencao.error) {
                showAlert('Erro ao carregar manutenção: ' + manutencao.error, 'danger');
                return;
            }
            
            // Preencher o formulário de edição
            document.getElementById('editar_id').value = manutencao.id;
            document.getElementById('editar_identificacao').value = manutencao.identificacao;
            document.getElementById('editar_tipo').value = manutencao.tipo;
            document.getElementById('editar_frota').value = manutencao.frota;
            document.getElementById('editar_descricao').value = manutencao.descricao;
            document.getElementById('editar_fornecedor').value = manutencao.fornecedor || '';
            document.getElementById('editar_valor').value = manutencao.valor;
            document.getElementById('editar_data_abertura').value = manutencao.data_abertura;
            document.getElementById('editar_previsao_conclusao').value = manutencao.previsao_conclusao || '';
            document.getElementById('editar_data_conclusao').value = manutencao.data_conclusao || '';
            document.getElementById('editar_observacoes').value = manutencao.observacoes || '';
            document.getElementById('editar_finalizada').checked = manutencao.finalizada;
            document.getElementById('editar_prazo_liberacao').value = manutencao.prazo_liberacao || '';
            document.getElementById('editar_forma_pagamento').value = manutencao.forma_pagamento || '';
            document.getElementById('editar_parcelas').value = manutencao.parcelas || 1;
            
            // Abrir o modal
            new bootstrap.Modal(document.getElementById('editarManutencaoModal')).show();
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Erro ao carregar dados da manutenção', 'danger');
        });
}

function salvarEdicao() {
    const id = document.getElementById('editar_id').value;
    
    const dados = {
        identificacao: document.getElementById('editar_identificacao').value,
        tipo: document.getElementById('editar_tipo').value,
        frota: document.getElementById('editar_frota').value,
        descricao: document.getElementById('editar_descricao').value,
        fornecedor: document.getElementById('editar_fornecedor').value,
        valor: parseFloat(document.getElementById('editar_valor').value) || 0,
        data_abertura: document.getElementById('editar_data_abertura').value,
        previsao_conclusao: document.getElementById('editar_previsao_conclusao').value || '',
        data_conclusao: document.getElementById('editar_data_conclusao').value || '',
        observacoes: document.getElementById('editar_observacoes').value || '',
        finalizada: document.getElementById('editar_finalizada').checked,
        prazo_liberacao: document.getElementById('editar_prazo_liberacao').value ? 
                         parseInt(document.getElementById('editar_prazo_liberacao').value) : null,
        forma_pagamento: document.getElementById('editar_forma_pagamento').value || '',
        parcelas: document.getElementById('editar_parcelas').value ? 
                 parseInt(document.getElementById('editar_parcelas').value) : 1
    };

    fetch(`/api/manutencoes/${id}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(dados)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('editarManutencaoModal')).hide();
            showAlert('Manutenção atualizada com sucesso!', 'success');
            carregarManutencoes(); // Recarregar dados
        } else {
            showAlert('Erro ao atualizar manutenção: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Erro ao atualizar manutenção', 'danger');
    });
}

function detalhesManutencao(id) {
    fetch(`/api/manutencoes/${id}`)
        .then(response => response.json())
        .then(manutencao => {
            if (manutencao.error) {
                showAlert('Erro ao carregar manutenção: ' + manutencao.error, 'danger');
                return;
            }
            
            const tipoFormatado = manutencao.tipo === 'corretiva' ? 'Corretiva' : 'Preventiva';
            const frotaFormatada = {
                'apoio': 'Apoio',
                'maquinas': 'Máquinas',
                'equipamento': 'Equipamento'
            }[manutencao.frota] || manutencao.frota;
            
            const valorFormatado = 'R$ ' + (manutencao.valor || 0).toLocaleString('pt-BR', { 
                minimumFractionDigits: 2, 
                maximumFractionDigits: 2 
            });
            
            const pagamentoFormatado = manutencao.forma_pagamento ? 
                `${manutencao.forma_pagamento}${manutencao.parcelas && manutencao.parcelas > 1 ? ` (${manutencao.parcelas}x)` : ''}` : 
                'Não informado';
            
            let prazoInfo = 'Não informado';
            if (manutencao.prazo_liberacao) {
                const dataAbertura = new Date(manutencao.data_abertura);
                const dataLimite = new Date(dataAbertura);
                dataLimite.setDate(dataLimite.getDate() + manutencao.prazo_liberacao);
                
                prazoInfo = `${manutencao.prazo_liberacao} dias úteis (até ${dataLimite.toLocaleDateString('pt-BR')})`;
            }
            
            const html = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Identificação</h6>
                        <p>${manutencao.identificacao}</p>
                    </div>
                    <div class="col-md-3">
                        <h6>Tipo</h6>
                        <p>${tipoFormatado}</p>
                    </div>
                    <div class="col-md-3">
                        <h6>Frota</h6>
                        <p>${frotaFormatada}</p>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6>Descrição</h6>
                        <p>${manutencao.descricao}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Fornecedor</h6>
                        <p>${manutencao.fornecedor || 'Não informado'}</p>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <h6>Valor</h6>
                        <p>${valorFormatado}</p>
                    </div>
                    <div class="col-md-4">
                        <h6>Forma de Pagamento</h6>
                        <p>${pagamentoFormatado}</p>
                    </div>
                    <div class="col-md-4">
                        <h6>Prazo para Liberação</h6>
                        <p>${prazoInfo}</p>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <h6>Data de Abertura</h6>
                        <p>${new Date(manutencao.data_abertura).toLocaleDateString('pt-BR')}</p>
                    </div>
                    <div class="col-md-4">
                        <h6>Previsão de Conclusão</h6>
                        <p>${manutencao.previsao_conclusao ? new Date(manutencao.previsao_conclusao).toLocaleDateString('pt-BR') : 'Não informada'}</p>
                    </div>
                    <div class="col-md-4">
                        <h6>Data de Conclusão</h6>
                        <p>${manutencao.data_conclusao ? new Date(manutencao.data_conclusao).toLocaleDateString('pt-BR') : 'Não concluída'}</p>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <h6>Observações</h6>
                        <p>${manutencao.observacoes || 'Nenhuma observação registrada'}</p>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6>Status</h6>
                        <span class="badge ${manutencao.finalizada ? 'bg-success' : 'bg-warning'}">
                            ${manutencao.finalizada ? 'Finalizada' : 'Em Aberto'}
                        </span>
                    </div>
                    <div class="col-md-6">
                        <h6>Data de Registro</h6>
                        <p>${new Date(manutencao.data_registro).toLocaleDateString('pt-BR')}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('detalhesConteudo').innerHTML = html;
            new bootstrap.Modal(document.getElementById('detalhesModal')).show();
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Erro ao carregar detalhes da manutenção', 'danger');
        });
}

function excluirManutencao(id) {
    if (!confirm('Tem certeza que deseja excluir esta manutenção?')) {
        return;
    }
    
    fetch(`/api/manutencoes/${id}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Manutenção excluída com sucesso!', 'success');
            carregarManutencoes(); // Recarregar dados
        } else {
            showAlert('Erro ao excluir manutenção: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Erro ao excluir manutenção', 'danger');
    });
}

function imprimirManutencao() {
    const conteudo = document.getElementById('detalhesConteudo').innerHTML;
    const janelaImpressao = window.open('', '_blank');
    
    janelaImpressao.document.write(`
        <html>
        <head>
            <title>Relatório de Manutenção</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                h4 { color: #0d6efd; margin-bottom: 20px; }
                .info-label { font-weight: bold; color: #6c757d; }
                @media print {
                    body { padding: 0; }
                    .no-print { display: none; }
                }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="row mb-4">
                    <div class="col-6">
                        <h4>Relatório de Manutenção</h4>
                    </div>
                    <div class="col-6 text-end">
                        <small>Emitido em: ${new Date().toLocaleDateString('pt-BR')}</small>
                    </div>
                </div>
                ${conteudo}
            </div>
            <div class="mt-4 no-print text-center">
                <button class="btn btn-primary" onclick="window.print()">Imprimir</button>
                <button class="btn btn-secondary" onclick="window.close()">Fechar</button>
            </div>
        </body>
        </html>
    `);
    
    janelaImpressao.document.close();
}

// --- NOVAS FUNÇÕES PARA RELATÓRIO COM FILTROS ---

function abrirModalFiltrosImpressao() {
    // Preencher os campos do modal com os filtros atuais (opcional)
    document.getElementById('filtroImpressaoIdentificacao').value = document.getElementById('filtroIdentificacao').value;
    document.getElementById('filtroImpressaoStatus').value = document.getElementById('filtroStatus').value;
    document.getElementById('filtroImpressaoTipo').value = document.getElementById('filtroTipo').value;
    document.getElementById('filtroImpressaoFrota').value = document.getElementById('filtroFrota').value;
    document.getElementById('filtroImpressaoPagamento').value = document.getElementById('filtroPagamento').value;
    
    // Definir datas padrão (últimos 30 dias)
    const dataFim = new Date();
    const dataInicio = new Date();
    dataInicio.setDate(dataInicio.getDate() - 30);
    
    document.getElementById('filtroImpressaoDataFim').value = dataFim.toISOString().split('T')[0];
    document.getElementById('filtroImpressaoDataInicio').value = dataInicio.toISOString().split('T')[0];
    
    // Abrir o modal
    new bootstrap.Modal(document.getElementById('filtrosImpressaoModal')).show();
}

function imprimirComFiltros() {
    const usarFiltrosAtuais = document.getElementById('filtroImpressaoUsarFiltrosAtuais').checked;
    
    let filtros = {};
    
    if (usarFiltrosAtuais) {
        // Usar filtros atuais da tela
        filtros = {
            identificacao: document.getElementById('filtroIdentificacao').value,
            status: document.getElementById('filtroStatus').value,
            tipo: document.getElementById('filtroTipo').value,
            frota: document.getElementById('filtroFrota').value,
            pagamento: document.getElementById('filtroPagamento').value,
            data_inicio: '',
            data_fim: '',
            ordenar_por: 'data_abertura',
            ordenar_direcao: 'desc'
        };
    } else {
        // Usar filtros do modal
        filtros = {
            identificacao: document.getElementById('filtroImpressaoIdentificacao').value,
            status: document.getElementById('filtroImpressaoStatus').value,
            tipo: document.getElementById('filtroImpressaoTipo').value,
            frota: document.getElementById('filtroImpressaoFrota').value,
            pagamento: document.getElementById('filtroImpressaoPagamento').value,
            data_inicio: document.getElementById('filtroImpressaoDataInicio').value,
            data_fim: document.getElementById('filtroImpressaoDataFim').value,
            ordenar_por: document.getElementById('filtroImpressaoOrdenar').value,
            ordenar_direcao: document.getElementById('filtroImpressaoOrdenarDirecao').value
        };
    }
    
    // Construir query string com os filtros
    const params = new URLSearchParams();
    Object.keys(filtros).forEach(key => {
        if (filtros[key] && filtros[key] !== 'todos') {
            params.append(key, filtros[key]);
        }
    });
    
    // Buscar dados filtrados para impressão
    fetch(`/api/manutencoes/relatorio?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('filtrosImpressaoModal')).hide();
                abrirJanelaImpressao(data);
            } else {
                showAlert('Erro ao gerar relatório: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            showAlert('Erro ao gerar relatório', 'danger');
        });
}

function abrirJanelaImpressao(data) {
    const { manutencoes, estatisticas, filtros_aplicados } = data;
    
    const janelaImpressao = window.open('', '_blank');
    const dataEmissao = new Date().toLocaleDateString('pt-BR');
    const horaEmissao = new Date().toLocaleTimeString('pt-BR');
    
    // Construir HTML do relatório
    let htmlRelatorio = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Relatório de Manutenções</title>
            <meta charset="UTF-8">
            <style>
                body { 
                    font-family: Arial, sans-serif; 
                    margin: 20px;
                    color: #333;
                }
                .header { 
                    text-align: center; 
                    margin-bottom: 30px;
                    border-bottom: 2px solid #333;
                    padding-bottom: 10px;
                }
                .header h1 { 
                    margin: 0; 
                    color: #0d6efd;
                }
                .info-emissao {
                    text-align: right;
                    font-size: 12px;
                    color: #666;
                    margin-bottom: 20px;
                }
                .resumo {
                    background: #f8f9fa;
                    padding: 15px;
                    border-radius: 5px;
                    margin-bottom: 20px;
                    border-left: 4px solid #0d6efd;
                }
                .resumo-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 15px;
                    margin-bottom: 20px;
                }
                .resumo-item {
                    text-align: center;
                    padding: 10px;
                    background: white;
                    border-radius: 5px;
                    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                }
                .resumo-item h3 {
                    margin: 0;
                    font-size: 24px;
                    color: #0d6efd;
                }
                .resumo-item p {
                    margin: 5px 0 0 0;
                    font-size: 12px;
                    color: #666;
                }
                table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-top: 20px;
                    font-size: 12px;
                }
                th {
                    background-color: #343a40;
                    color: white;
                    padding: 8px;
                    text-align: left;
                    border: 1px solid #dee2e6;
                }
                td {
                    padding: 8px;
                    border: 1px solid #dee2e6;
                }
                tr:nth-child(even) {
                    background-color: #f8f9fa;
                }
                .status-aberto { color: #fd7e14; font-weight: bold; }
                .status-finalizado { color: #198754; font-weight: bold; }
                .badge {
                    padding: 4px 8px;
                    border-radius: 4px;
                    font-size: 11px;
                    font-weight: bold;
                }
                .badge-aberto { background: #fff3cd; color: #856404; }
                .badge-finalizado { background: #d1e7dd; color: #0f5132; }
                .filtros-info {
                    background: #e9ecef;
                    padding: 10px;
                    border-radius: 5px;
                    margin-bottom: 20px;
                    font-size: 12px;
                }
                .filtros-info h4 {
                    margin: 0 0 10px 0;
                    color: #495057;
                }
                .filtro-item {
                    display: inline-block;
                    margin-right: 15px;
                }
                .filtro-item strong {
                    color: #495057;
                }
                @media print {
                    body { margin: 0; }
                    .no-print { display: none; }
                    .header { margin-top: 0; }
                }
                .total-geral {
                    background: #e7f3ff;
                    padding: 10px;
                    border-radius: 5px;
                    margin-top: 20px;
                    text-align: center;
                    font-weight: bold;
                    border: 1px solid #b6d4fe;
                }
                .periodo-info {
                    background: #fff3cd;
                    padding: 10px;
                    border-radius: 5px;
                    margin-bottom: 15px;
                    border-left: 4px solid #ffc107;
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>Relatório de Manutenções</h1>
                <p>Sistema de Gestão de Frotas</p>
            </div>
            
            <div class="info-emissao">
                Emitido em: ${dataEmissao} às ${horaEmissao}
            </div>
    `;
    
    // Informações de período se aplicável
    if (filtros_aplicados.data_inicio || filtros_aplicados.data_fim) {
        const periodoInicio = filtros_aplicados.data_inicio ? 
            new Date(filtros_aplicados.data_inicio).toLocaleDateString('pt-BR') : 'Início indefinido';
        const periodoFim = filtros_aplicados.data_fim ? 
            new Date(filtros_aplicados.data_fim).toLocaleDateString('pt-BR') : 'Fim indefinido';
        
        htmlRelatorio += `
            <div class="periodo-info">
                <strong>Período:</strong> ${periodoInicio} à ${periodoFim}
            </div>
        `;
    }
    
    htmlRelatorio += `
            <div class="filtros-info">
                <h4>Filtros Aplicados:</h4>
                <div class="filtro-item"><strong>Identificação:</strong> ${filtros_aplicados.identificacao || 'Todos'}</div>
                <div class="filtro-item"><strong>Status:</strong> ${filtros_aplicados.status === 'aberto' ? 'Abertas' : filtros_aplicados.status === 'finalizado' ? 'Finalizadas' : 'Todos'}</div>
                <div class="filtro-item"><strong>Tipo:</strong> ${filtros_aplicados.tipo === 'corretiva' ? 'Corretiva' : filtros_aplicados.tipo === 'preventiva' ? 'Preventiva' : 'Todos'}</div>
                <div class="filtro-item"><strong>Frota:</strong> ${filtros_aplicados.frota === 'apoio' ? 'Apoio' : filtros_aplicados.frota === 'maquinas' ? 'Máquinas' : filtros_aplicados.frota === 'equipamento' ? 'Equipamento' : 'Todos'}</div>
                <div class="filtro-item"><strong>Pagamento:</strong> ${filtros_aplicados.pagamento && filtros_aplicados.pagamento !== 'todos' ? filtros_aplicados.pagamento : 'Todos'}</div>
                <div class="filtro-item"><strong>Ordenação:</strong> ${filtros_aplicados.ordenar_por === 'valor' ? 'Valor' : filtros_aplicados.ordenar_por === 'identificacao' ? 'Identificação' : 'Data'} (${filtros_aplicados.ordenar_direcao === 'asc' ? 'Crescente' : 'Decrescente'})</div>
            </div>
            
            <div class="resumo-grid">
                <div class="resumo-item">
                    <h3>${estatisticas.total}</h3>
                    <p>TOTAL DE MANUTENÇÕES</p>
                </div>
                <div class="resumo-item">
                    <h3>${estatisticas.abertas}</h3>
                    <p>EM ABERTO</p>
                </div>
                <div class="resumo-item">
                    <h3>${estatisticas.finalizadas}</h3>
                    <p>FINALIZADAS</p>
                </div>
                <div class="resumo-item">
                    <h3>R$ ${estatisticas.valor_total.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</h3>
                    <p>VALOR TOTAL</p>
                </div>
            </div>
    `;
    
    // Tabela de manutenções
    if (manutencoes.length > 0) {
        htmlRelatorio += `
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Identificação</th>
                        <th>Tipo</th>
                        <th>Frota</th>
                        <th>Descrição</th>
                        <th>Fornecedor</th>
                        <th>Valor (R$)</th>
                        <th>Pagamento</th>
                        <th>Status</th>
                        <th>Data Abertura</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        manutencoes.forEach(manutencao => {
            const tipoFormatado = manutencao.tipo === 'corretiva' ? 'Corretiva' : 'Preventiva';
            const frotaFormatada = {
                'apoio': 'Apoio',
                'maquinas': 'Máquinas',
                'equipamento': 'Equipamento'
            }[manutencao.frota] || manutencao.frota;
            
            const valorFormatado = manutencao.valor ? 
                manutencao.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '0,00';
            
            const pagamentoFormatado = manutencao.forma_pagamento ? 
                `${manutencao.forma_pagamento}${manutencao.parcelas && manutencao.parcelas > 1 ? ` (${manutencao.parcelas}x)` : ''}` : 
                '-';
            
            const statusClass = manutencao.finalizada ? 'status-finalizado badge badge-finalizado' : 'status-aberto badge badge-aberto';
            const statusText = manutencao.finalizada ? 'FINALIZADA' : 'EM ABERTO';
            
            const dataAbertura = manutencao.data_abertura ? 
                new Date(manutencao.data_abertura).toLocaleDateString('pt-BR') : '-';
            
            htmlRelatorio += `
                <tr>
                    <td>${manutencao.id}</td>
                    <td>${manutencao.identificacao}</td>
                    <td>${tipoFormatado}</td>
                    <td>${frotaFormatada}</td>
                    <td>${manutencao.descricao}</td>
                    <td>${manutencao.fornecedor || '-'}</td>
                    <td style="text-align: right;">${valorFormatado}</td>
                    <td>${pagamentoFormatado}</td>
                    <td><span class="${statusClass}">${statusText}</span></td>
                    <td>${dataAbertura}</td>
                </tr>
            `;
        });
        
        htmlRelatorio += `
                </tbody>
            </table>
            
            <div class="total-geral">
                TOTAL GERAL: R$ ${estatisticas.valor_total.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
            </div>
        `;
    } else {
        htmlRelatorio += `
            <div style="text-align: center; padding: 40px; color: #666;">
                <h3>Nenhuma manutenção encontrada com os filtros aplicados</h3>
            </div>
        `;
    }
    
    htmlRelatorio += `
            <div class="no-print" style="margin-top: 30px; text-align: center;">
                <button onclick="window.print()" style="padding: 10px 20px; background: #0d6efd; color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                    Imprimir Relatório
                </button>
                <button onclick="window.close()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    Fechar
                </button>
            </div>
        </body>
        </html>
    `;
    
    janelaImpressao.document.write(htmlRelatorio);
    janelaImpressao.document.close();
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '1050';
    alertDiv.style.minWidth = '300px';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}