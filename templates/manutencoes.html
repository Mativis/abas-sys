{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
        <div>
            <i class="bi bi-tools"></i> Controle de Manutenções
        </div>
        <div>
            <button class="btn btn-light btn-sm me-2" onclick="imprimirRelatorioCompleto()" title="Imprimir Relatório">
                <i class="bi bi-printer"></i> Relatório
            </button>
            <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#novaManutencaoModal">
                <i class="bi bi-plus-circle"></i> Nova Manutenção
            </button>
        </div>
    </div>
    <div class="card-body">
        <!-- Filtros -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" id="filtroIdentificacao" class="form-control" placeholder="Filtrar por identificação...">
                </div>
            </div>
            <div class="col-md-2">
                <select id="filtroStatus" class="form-select">
                    <option value="todos">Todos os status</option>
                    <option value="aberto">Abertas</option>
                    <option value="finalizado">Finalizadas</option>
                </select>
            </div>
            <div class="col-md-2">
                <select id="filtroTipo" class="form-select">
                    <option value="todos">Todos os tipos</option>
                    <option value="corretiva">Corretiva</option>
                    <option value="preventiva">Preventiva</option>
                </select>
            </div>
            <div class="col-md-2">
                <select id="filtroFrota" class="form-select">
                    <option value="todos">Todas as frotas</option>
                    <option value="apoio">Apoio</option>
                    <option value="maquinas">Máquinas</option>
                    <option value="equipamento">Equipamento</option>
                </select>
            </div>
            <div class="col-md-3">
                <select id="filtroPagamento" class="form-select">
                    <option value="todos">Todas as formas de pagamento</option>
                    <option value="dinheiro">Dinheiro</option>
                    <option value="pix">PIX</option>
                    <option value="cartao_credito">Cartão de Crédito</option>
                    <option value="cartao_debito">Cartão de Débito</option>
                    <option value="transferencia">Transferência</option>
                    <option value="boleto">Boleto</option>
                </select>
            </div>
        </div>

        <!-- Cards de Resumo -->
        <div class="row mb-4">
            <div class="col-md-2">
                <div class="card text-center bg-primary text-white">
                    <div class="card-body">
                        <h5><i class="bi bi-tools"></i> Total</h5>
                        <h3 id="total-manutencoes">{{ total_manutencoes }}</h3>
                        <small>Manutenções</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center bg-warning text-dark">
                    <div class="card-body">
                        <h5><i class="bi bi-clock"></i> Abertas</h5>
                        <h3 id="total-abertas">{{ manutencoes_abertas }}</h3>
                        <small>Em andamento</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center bg-success text-white">
                    <div class="card-body">
                        <h5><i class="bi bi-check-circle"></i> Finalizadas</h5>
                        <h3 id="total-finalizadas">{{ manutencoes_finalizadas }}</h3>
                        <small>Concluídas</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-danger text-white">
                    <div class="card-body">
                        <h5><i class="bi bi-currency-dollar"></i> Valor Total</h5>
                        <h3 id="valor-total">R$ {{ "%.2f"|format(valor_total) }}</h3>
                        <small>Total em manutenções</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-info text-white">
                    <div class="card-body">
                        <h5><i class="bi bi-calendar-check"></i> Próximas</h5>
                        <h3 id="proximas-liberacao">0</h3>
                        <small>Próximas da liberação</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabela de Manutenções -->
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="tabelaManutencoes">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Identificação</th>
                        <th>Tipo</th>
                        <th>Frota</th>
                        <th>Descrição</th>
                        <th>Fornecedor</th>
                        <th class="text-end">Valor</th>
                        <th>Pagamento</th>
                        <th class="text-center">Status</th>
                        <th class="text-center">Ações</th>
                    </tr>
                </thead>
                <tbody id="corpoTabela">
                    {% for manutencao in manutencoes %}
                    <tr id="row-{{ manutencao.id }}">
                        <td>{{ manutencao.id }}</td>
                        <td>{{ manutencao.identificacao }}</td>
                        <td>{{ 'Corretiva' if manutencao.tipo == 'corretiva' else 'Preventiva' }}</td>
                        <td>
                            {% if manutencao.frota == 'apoio' %}Apoio
                            {% elif manutencao.frota == 'maquinas' %}Máquinas
                            {% elif manutencao.frota == 'equipamento' %}Equipamento
                            {% else %}{{ manutencao.frota }}{% endif %}
                        </td>
                        <td>{{ manutencao.descricao[:50] }}{% if manutencao.descricao|length > 50 %}...{% endif %}</td>
                        <td>{{ manutencao.fornecedor or '-' }}</td>
                        <td class="text-end">R$ {{ "%.2f"|format(manutencao.valor) }}</td>
                        <td>
                            {% if manutencao.forma_pagamento %}
                                {{ manutencao.forma_pagamento }}{% if manutencao.parcelas and manutencao.parcelas > 1 %} ({{ manutencao.parcelas }}x){% endif %}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <span class="badge {% if manutencao.finalizada %}bg-success{% else %}bg-warning{% endif %}">
                                {{ 'Finalizada' if manutencao.finalizada else 'Em Aberto' }}
                            </span>
                        </td>
                        <td class="text-center">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-info" onclick="detalhesManutencao({{ manutencao.id }})" title="Detalhes">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-outline-primary" onclick="editarManutencao({{ manutencao.id }})" title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="excluirManutencao({{ manutencao.id }})" title="Excluir">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="10" class="text-center py-4">
                            <i class="bi bi-inbox"></i>
                            <p class="text-muted">Nenhuma manutenção cadastrada.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Nova Manutenção -->
<div class="modal fade" id="novaManutencaoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nova Manutenção</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="formNovaManutencao">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Tipo de Manutenção *</label>
                            <select class="form-select" name="tipo" required>
                                <option value="">Selecione...</option>
                                <option value="corretiva">Corretiva</option>
                                <option value="preventiva">Preventiva</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Tipo de Frota *</label>
                            <select class="form-select" name="frota" required>
                                <option value="">Selecione...</option>
                                <option value="apoio">Apoio</option>
                                <option value="maquinas">Máquinas</option>
                                <option value="equipamento">Equipamento</option>
                            </select>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Identificação *</label>
                            <input type="text" class="form-control" name="identificacao" required 
                                   placeholder="Ex: Caminhão ABC-1234, Máquina XYZ, etc.">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Data de Abertura *</label>
                            <input type="date" class="form-control" name="data_abertura" required 
                                   value="{{ now.strftime('%Y-%m-%d') }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Previsão de Conclusão</label>
                            <input type="date" class="form-control" name="previsao_conclusao">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Prazo para Liberação (dias úteis)</label>
                            <input type="number" min="0" class="form-control" name="prazo_liberacao" 
                                   placeholder="Ex: 5">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Forma de Pagamento</label>
                            <select class="form-select" name="forma_pagamento">
                                <option value="">Selecione...</option>
                                <option value="dinheiro">Dinheiro</option>
                                <option value="pix">PIX</option>
                                <option value="cartao_credito">Cartão de Crédito</option>
                                <option value="cartao_debito">Cartão de Débito</option>
                                <option value="transferencia">Transferência</option>
                                <option value="boleto">Boleto</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Parcelas</label>
                            <input type="number" min="1" max="24" class="form-control" name="parcelas" 
                                   placeholder="Nº de parcelas" value="1">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Manutenção a Ser Realizada *</label>
                            <textarea class="form-control" name="descricao" rows="3" required 
                                      placeholder="Descreva detalhadamente a manutenção necessária..."></textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Fornecedor</label>
                            <input type="text" class="form-control" name="fornecedor" 
                                   placeholder="Nome do fornecedor">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Valor Orçado (R$)</label>
                            <input type="number" step="0.01" min="0" class="form-control" 
                                   name="valor" placeholder="0,00">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Observações</label>
                            <textarea class="form-control" name="observacoes" rows="2" 
                                      placeholder="Informações adicionais..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Editar Manutenção -->
<div class="modal fade" id="editarManutencaoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar Manutenção</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="formEditarManutencao">
                <input type="hidden" id="editar_id">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Tipo de Manutenção *</label>
                            <select class="form-select" id="editar_tipo" required>
                                <option value="">Selecione...</option>
                                <option value="corretiva">Corretiva</option>
                                <option value="preventiva">Preventiva</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Tipo de Frota *</label>
                            <select class="form-select" id="editar_frota" required>
                                <option value="">Selecione...</option>
                                <option value="apoio">Apoio</option>
                                <option value="maquinas">Máquinas</option>
                                <option value="equipamento">Equipamento</option>
                            </select>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Identificação *</label>
                            <input type="text" class="form-control" id="editar_identificacao" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Data de Abertura *</label>
                            <input type="date" class="form-control" id="editar_data_abertura" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Data de Conclusão</label>
                            <input type="date" class="form-control" id="editar_data_conclusao">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Previsão de Conclusão</label>
                            <input type="date" class="form-control" id="editar_previsao_conclusao">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Prazo para Liberação (dias úteis)</label>
                            <input type="number" min="0" class="form-control" id="editar_prazo_liberacao">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Forma de Pagamento</label>
                            <select class="form-select" id="editar_forma_pagamento">
                                <option value="">Selecione...</option>
                                <option value="dinheiro">Dinheiro</option>
                                <option value="pix">PIX</option>
                                <option value="cartao_credito">Cartão de Crédito</option>
                                <option value="cartao_debito">Cartão de Débito</option>
                                <option value="transferencia">Transferência</option>
                                <option value="boleto">Boleto</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Parcelas</label>
                            <input type="number" min="1" max="24" class="form-control" id="editar_parcelas" value="1">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Manutenção a Ser Realizada *</label>
                            <textarea class="form-control" id="editar_descricao" rows="3" required></textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Fornecedor</label>
                            <input type="text" class="form-control" id="editar_fornecedor">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Valor Orçado (R$)</label>
                            <input type="number" step="0.01" min="0" class="form-control" id="editar_valor">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Observações</label>
                            <textarea class="form-control" id="editar_observacoes" rows="2"></textarea>
                        </div>
                        <div class="col-12">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="editar_finalizada">
                                <label class="form-check-label" for="editar_finalizada">Manutenção Finalizada</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarEdicao()">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Detalhes/Impressão -->
<div class="modal fade" id="detalhesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalhes da Manutenção</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detalhesConteudo">
                <!-- Conteúdo será preenchido via JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" onclick="imprimirManutencao()">
                    <i class="bi bi-printer"></i> Imprimir
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Variáveis globais
let manutencoes = [];

// Carregar dados ao iniciar
document.addEventListener('DOMContentLoaded', function() {
    carregarManutencoes();
    configurarFiltros();
    configurarFormularios();
});

function carregarManutencoes() {
    fetch('/api/manutencoes')
        .then(response => response.json())
        .then(data => {
            console.log('Dados recebidos:', data); // Debug
            if (data.manutencoes && Array.isArray(data.manutencoes)) {
                manutencoes = data.manutencoes;
                
                // Atualizar estatísticas do dashboard
                if (data.estatisticas) {
                    document.getElementById('total-manutencoes').textContent = data.estatisticas.total;
                    document.getElementById('total-abertas').textContent = data.estatisticas.abertas;
                    document.getElementById('total-finalizadas').textContent = data.estatisticas.finalizadas;
                    document.getElementById('valor-total').textContent = 
                        'R$ ' + data.estatisticas.valor_total.toLocaleString('pt-BR', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        });
                    
                    // Calcular manutenções próximas da liberação
                    const hoje = new Date();
                    const proximas = manutencoes.filter(m => {
                        if (m.finalizada || !m.prazo_liberacao || !m.data_abertura) return false;
                        
                        const dataAbertura = new Date(m.data_abertura);
                        const dataLimite = new Date(dataAbertura);
                        dataLimite.setDate(dataLimite.getDate() + m.prazo_liberacao);
                        
                        const diffTime = dataLimite - hoje;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        
                        return diffDays <= 3 && diffDays >= 0;
                    });
                    
                    document.getElementById('proximas-liberacao').textContent = proximas.length;
                }
            } else {
                console.error('Estrutura de dados inválida:', data);
                manutencoes = [];
            }
            aplicarFiltros();
        })
        .catch(error => {
            console.error('Erro ao carregar manutenções:', error);
            manutencoes = [];
            aplicarFiltros();
        });
}

function configurarFiltros() {
    // Filtro de identificação
    document.getElementById('filtroIdentificacao').addEventListener('input', aplicarFiltros);
    
    // Filtro de status
    document.getElementById('filtroStatus').addEventListener('change', aplicarFiltros);
    
    // Filtro de tipo
    document.getElementById('filtroTipo').addEventListener('change', aplicarFiltros);
    
    // Filtro de frota
    document.getElementById('filtroFrota').addEventListener('change', aplicarFiltros);
    
    // Filtro de forma de pagamento
    document.getElementById('filtroPagamento').addEventListener('change', aplicarFiltros);
}

function configurarFormularios() {
    // Formulário de nova manutenção
    document.getElementById('formNovaManutencao').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        const dados = {
            identificacao: formData.get('identificacao'),
            tipo: formData.get('tipo'),
            frota: formData.get('frota'),
            descricao: formData.get('descricao'),
            fornecedor: formData.get('fornecedor'),
            valor: parseFloat(formData.get('valor')) || 0,
            data_abertura: formData.get('data_abertura'),
            previsao_conclusao: formData.get('previsao_conclusao') || '',
            data_conclusao: formData.get('data_conclusao') || '',
            observacoes: formData.get('observacoes') || '',
            finalizada: false,
            prazo_liberacao: formData.get('prazo_liberacao') ? parseInt(formData.get('prazo_liberacao')) : null,
            forma_pagamento: formData.get('forma_pagamento') || '',
            parcelas: formData.get('parcelas') ? parseInt(formData.get('parcelas')) : 1
        };

        fetch('/api/manutencoes', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(dados)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('novaManutencaoModal')).hide();
                this.reset();
                showAlert('Manutenção cadastrada com sucesso!', 'success');
                carregarManutencoes(); // Recarregar dados
            } else {
                showAlert('Erro ao cadastrar manutenção: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Erro ao cadastrar manutenção', 'danger');
        });
    });
}

function aplicarFiltros() {
    const filtroIdentificacao = document.getElementById('filtroIdentificacao').value.toLowerCase();
    const filtroStatus = document.getElementById('filtroStatus').value;
    const filtroTipo = document.getElementById('filtroTipo').value;
    const filtroFrota = document.getElementById('filtroFrota').value;
    const filtroPagamento = document.getElementById('filtroPagamento').value;
    
    let dadosFiltrados = manutencoes.filter(manutencao => {
        // Filtro por identificação
        if (filtroIdentificacao && !manutencao.identificacao.toLowerCase().includes(filtroIdentificacao)) {
            return false;
        }
        
        // Filtro por status
        if (filtroStatus !== 'todos') {
            if (filtroStatus === 'aberto' && manutencao.finalizada) return false;
            if (filtroStatus === 'finalizado' && !manutencao.finalizada) return false;
        }
        
        // Filtro por tipo
        if (filtroTipo !== 'todos' && manutencao.tipo !== filtroTipo) {
            return false;
        }
        
        // Filtro por frota
        if (filtroFrota !== 'todos' && manutencao.frota !== filtroFrota) {
            return false;
        }
        
        // Filtro por forma de pagamento
        if (filtroPagamento !== 'todos' && manutencao.forma_pagamento !== filtroPagamento) {
            return false;
        }
        
        return true;
    });
    
    atualizarTabela(dadosFiltrados);
}

function atualizarTabela(dados) {
    const tbody = document.getElementById('corpoTabela');
    console.log('Atualizando tabela com:', dados); // Debug
    
    if (!dados || dados.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="10" class="text-center py-4">
                    <i class="bi bi-inbox"></i>
                    <p class="text-muted">Nenhuma manutenção encontrada com os filtros aplicados.</p>
                </td>
            </tr>
        `;
        return;
    }

    let html = '';
    dados.forEach(manutencao => {
        // Adicionar verificações para evitar erros
        const valor = manutencao.valor || 0;
        const valorFormatado = 'R$ ' + valor.toLocaleString('pt-BR', { 
            minimumFractionDigits: 2, 
            maximumFractionDigits: 2 
        });
        
        const tipoFormatado = manutencao.tipo === 'corretiva' ? 'Corretiva' : 'Preventiva';
        
        const frotaFormatada = {
            'apoio': 'Apoio',
            'maquinas': 'Máquinas',
            'equipamento': 'Equipamento'
        }[manutencao.frota] || manutencao.frota;
        
        // Verificar se as propriedades existem antes de acessá-las
        const formaPagamento = manutencao.forma_pagamento || '';
        const parcelas = manutencao.parcelas || 0;
        
        const pagamentoFormatado = formaPagamento ? 
            `${formaPagamento}${parcelas > 1 ? ` (${parcelas}x)` : ''}` : 
            '-';
        
        const descricao = manutencao.descricao || '';
        const descricaoTruncada = descricao.length > 50 ? 
            descricao.substring(0, 50) + '...' : descricao;
        
        html += `
            <tr id="row-${manutencao.id}">
                <td>${manutencao.id}</td>
                <td>${manutencao.identificacao || '-'}</td>
                <td>${tipoFormatado}</td>
                <td>${frotaFormatada}</td>
                <td>${descricaoTruncada}</td>
                <td>${manutencao.fornecedor || '-'}</td>
                <td class="text-end">${valorFormatado}</td>
                <td>${pagamentoFormatado}</td>
                <td class="text-center">
                    <span class="badge ${manutencao.finalizada ? 'bg-success' : 'bg-warning'}">
                        ${manutencao.finalizada ? 'Finalizada' : 'Em Aberto'}
                    </span>
                </td>
                <td class="text-center">
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-info" onclick="detalhesManutencao(${manutencao.id})" title="Detalhes">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-outline-primary" onclick="editarManutencao(${manutencao.id})" title="Editar">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="excluirManutencao(${manutencao.id})" title="Excluir">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });

    tbody.innerHTML = html;
}

function editarManutencao(id) {
    fetch(`/api/manutencoes/${id}`)
        .then(response => response.json())
        .then(manutencao => {
            if (manutencao.error) {
                showAlert('Erro ao carregar manutenção: ' + manutencao.error, 'danger');
                return;
            }
            
            // Preencher o formulário de edição
            document.getElementById('editar_id').value = manutencao.id;
            document.getElementById('editar_identificacao').value = manutencao.identificacao;
            document.getElementById('editar_tipo').value = manutencao.tipo;
            document.getElementById('editar_frota').value = manutencao.frota;
            document.getElementById('editar_descricao').value = manutencao.descricao;
            document.getElementById('editar_fornecedor').value = manutencao.fornecedor || '';
            document.getElementById('editar_valor').value = manutencao.valor;
            document.getElementById('editar_data_abertura').value = manutencao.data_abertura;
            document.getElementById('editar_previsao_conclusao').value = manutencao.previsao_conclusao || '';
            document.getElementById('editar_data_conclusao').value = manutencao.data_conclusao || '';
            document.getElementById('editar_observacoes').value = manutencao.observacoes || '';
            document.getElementById('editar_finalizada').checked = manutencao.finalizada;
            document.getElementById('editar_prazo_liberacao').value = manutencao.prazo_liberacao || '';
            document.getElementById('editar_forma_pagamento').value = manutencao.forma_pagamento || '';
            document.getElementById('editar_parcelas').value = manutencao.parcelas || 1;
            
            // Abrir o modal
            new bootstrap.Modal(document.getElementById('editarManutencaoModal')).show();
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Erro ao carregar dados da manutenção', 'danger');
        });
}

function salvarEdicao() {
    const id = document.getElementById('editar_id').value;
    
    const dados = {
        identificacao: document.getElementById('editar_identificacao').value,
        tipo: document.getElementById('editar_tipo').value,
        frota: document.getElementById('editar_frota').value,
        descricao: document.getElementById('editar_descricao').value,
        fornecedor: document.getElementById('editar_fornecedor').value,
        valor: parseFloat(document.getElementById('editar_valor').value) || 0,
        data_abertura: document.getElementById('editar_data_abertura').value,
        previsao_conclusao: document.getElementById('editar_previsao_conclusao').value || '',
        data_conclusao: document.getElementById('editar_data_conclusao').value || '',
        observacoes: document.getElementById('editar_observacoes').value || '',
        finalizada: document.getElementById('editar_finalizada').checked,
        prazo_liberacao: document.getElementById('editar_prazo_liberacao').value ? 
                         parseInt(document.getElementById('editar_prazo_liberacao').value) : null,
        forma_pagamento: document.getElementById('editar_forma_pagamento').value || '',
        parcelas: document.getElementById('editar_parcelas').value ? 
                 parseInt(document.getElementById('editar_parcelas').value) : 1
    };

    fetch(`/api/manutencoes/${id}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(dados)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('editarManutencaoModal')).hide();
            showAlert('Manutenção atualizada com sucesso!', 'success');
            carregarManutencoes(); // Recarregar dados
        } else {
            showAlert('Erro ao atualizar manutenção: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Erro ao atualizar manutenção', 'danger');
    });
}

function detalhesManutencao(id) {
    fetch(`/api/manutencoes/${id}`)
        .then(response => response.json())
        .then(manutencao => {
            if (manutencao.error) {
                showAlert('Erro ao carregar manutenção: ' + manutencao.error, 'danger');
                return;
            }
            
            const tipoFormatado = manutencao.tipo === 'corretiva' ? 'Corretiva' : 'Preventiva';
            const frotaFormatada = {
                'apoio': 'Apoio',
                'maquinas': 'Máquinas',
                'equipamento': 'Equipamento'
            }[manutencao.frota] || manutencao.frota;
            
            const valorFormatado = 'R$ ' + (manutencao.valor || 0).toLocaleString('pt-BR', { 
                minimumFractionDigits: 2, 
                maximumFractionDigits: 2 
            });
            
            const pagamentoFormatado = manutencao.forma_pagamento ? 
                `${manutencao.forma_pagamento}${manutencao.parcelas && manutencao.parcelas > 1 ? ` (${manutencao.parcelas}x)` : ''}` : 
                'Não informado';
            
            let prazoInfo = 'Não informado';
            if (manutencao.prazo_liberacao) {
                const dataAbertura = new Date(manutencao.data_abertura);
                const dataLimite = new Date(dataAbertura);
                dataLimite.setDate(dataLimite.getDate() + manutencao.prazo_liberacao);
                
                prazoInfo = `${manutencao.prazo_liberacao} dias úteis (até ${dataLimite.toLocaleDateString('pt-BR')})`;
            }
            
            const html = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Identificação</h6>
                        <p>${manutencao.identificacao}</p>
                    </div>
                    <div class="col-md-3">
                        <h6>Tipo</h6>
                        <p>${tipoFormatado}</p>
                    </div>
                    <div class="col-md-3">
                        <h6>Frota</h6>
                        <p>${frotaFormatada}</p>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6>Descrição</h6>
                        <p>${manutencao.descricao}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Fornecedor</h6>
                        <p>${manutencao.fornecedor || 'Não informado'}</p>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <h6>Valor</h6>
                        <p>${valorFormatado}</p>
                    </div>
                    <div class="col-md-4">
                        <h6>Forma de Pagamento</h6>
                        <p>${pagamentoFormatado}</p>
                    </div>
                    <div class="col-md-4">
                        <h6>Prazo para Liberação</h6>
                        <p>${prazoInfo}</p>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <h6>Data de Abertura</h6>
                        <p>${new Date(manutencao.data_abertura).toLocaleDateString('pt-BR')}</p>
                    </div>
                    <div class="col-md-4">
                        <h6>Previsão de Conclusão</h6>
                        <p>${manutencao.previsao_conclusao ? new Date(manutencao.previsao_conclusao).toLocaleDateString('pt-BR') : 'Não informada'}</p>
                    </div>
                    <div class="col-md-4">
                        <h6>Data de Conclusão</h6>
                        <p>${manutencao.data_conclusao ? new Date(manutencao.data_conclusao).toLocaleDateString('pt-BR') : 'Não concluída'}</p>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <h6>Observações</h6>
                        <p>${manutencao.observacoes || 'Nenhuma observação registrada'}</p>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6>Status</h6>
                        <span class="badge ${manutencao.finalizada ? 'bg-success' : 'bg-warning'}">
                            ${manutencao.finalizada ? 'Finalizada' : 'Em Aberto'}
                        </span>
                    </div>
                    <div class="col-md-6">
                        <h6>Data de Registro</h6>
                        <p>${new Date(manutencao.data_registro).toLocaleDateString('pt-BR')}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('detalhesConteudo').innerHTML = html;
            new bootstrap.Modal(document.getElementById('detalhesModal')).show();
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Erro ao carregar detalhes da manutenção', 'danger');
        });
}

function excluirManutencao(id) {
    if (!confirm('Tem certeza que deseja excluir esta manutenção?')) {
        return;
    }
    
    fetch(`/api/manutencoes/${id}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Manutenção excluída com sucesso!', 'success');
            carregarManutencoes(); // Recarregar dados
        } else {
            showAlert('Erro ao excluir manutenção: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Erro ao excluir manutenção', 'danger');
    });
}

function imprimirManutencao() {
    const conteudo = document.getElementById('detalhesConteudo').innerHTML;
    const janelaImpressao = window.open('', '_blank');
    
    janelaImpressao.document.write(`
        <html>
        <head>
            <title>Relatório de Manutenção</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                h4 { color: #0d6efd; margin-bottom: 20px; }
                .info-label { font-weight: bold; color: #6c757d; }
                @media print {
                    body { padding: 0; }
                    .no-print { display: none; }
                }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="row mb-4">
                    <div class="col-6">
                        <h4>Relatório de Manutenção</h4>
                    </div>
                    <div class="col-6 text-end">
                        <small>Emitido em: ${new Date().toLocaleDateString('pt-BR')}</small>
                    </div>
                </div>
                ${conteudo}
            </div>
            <div class="mt-4 no-print text-center">
                <button class="btn btn-primary" onclick="window.print()">Imprimir</button>
                <button class="btn btn-secondary" onclick="window.close()">Fechar</button>
            </div>
        </body>
        </html>
    `);
    
    janelaImpressao.document.close();
}

function imprimirRelatorioCompleto() {
    // Calcular totais
    const totalValor = manutencoes.reduce((sum, m) => sum + (m.valor || 0), 0);
    const totalPrazoLiberacao = manutencoes.reduce((sum, m) => sum + (m.prazo_liberacao || 0), 0);
    const totalManutencoes = manutencoes.length;
    const manutencoesAbertas = manutencoes.filter(m => !m.finalizada).length;
    const manutencoesFinalizadas = manutencoes.filter(m => m.finalizada).length;

    // Filtrar manutenções a serem feitas (em aberto)
    const manutencoesPendentes = manutencoes.filter(m => !m.finalizada);
    const manutencoesConcluidas = manutencoes.filter(m => m.finalizada);

    // Agrupar por tipo
    const porTipo = {
        corretiva: manutencoes.filter(m => m.tipo === 'corretiva').length,
        preventiva: manutencoes.filter(m => m.tipo === 'preventiva').length
    };

    // Agrupar por frota
    const porFrota = {};
    manutencoes.forEach(m => {
        porFrota[m.frota] = (porFrota[m.frota] || 0) + 1;
    });

    // Formatar dados para impressão
    const dataEmissao = new Date().toLocaleDateString('pt-BR');
    const horaEmissao = new Date().toLocaleTimeString('pt-BR');
    
    const conteudoRelatorio = `
        <div class="container-fluid">
            <div class="row mb-4">
                <div class="col-12 text-center">
                    <h2>Relatório Completo de Manutenções</h2>
                    <p class="mb-0"><strong>Data de emissão:</strong> ${dataEmissao} às ${horaEmissao}</p>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card border-primary">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Resumo Geral</h5>
                        </div>
                        <div class="card-body">
                            <p>Total de Manutenções: <strong>${totalManutencoes}</strong></p>
                            <p>Valor Total: <strong>R$ ${totalValor.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong></p>
                            <p>Prazo Total p/ Liberação: <strong>${totalPrazoLiberacao} dias</strong></p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-warning">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0">Status das Manutenções</h5>
                        </div>
                        <div class="card-body">
                            <p>Em Aberto: <strong>${manutencoesAbertas}</strong></p>
                            <p>Finalizadas: <strong>${manutencoesFinalizadas}</strong></p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-success">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">Distribuição por Tipo</h5>
                        </div>
                        <div class="card-body">
                            <p>Corretivas: <strong>${porTipo.corretiva}</strong></p>
                            <p>Preventivas: <strong>${porTipo.preventiva}</strong></p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-12">
                    <div class="card border-info">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">Distribuição por Frota</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                ${Object.entries(porFrota).map(([frota, quantidade]) => `
                                    <div class="col-md-3">
                                        <p>${frota.charAt(0).toUpperCase() + frota.slice(1)}: <strong>${quantidade}</strong></p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-12">
                    <h4 class="text-center mb-3">Manutenções Pendentes (A Serem Feitas)</h4>
                    ${manutencoesPendentes.length > 0 ? `
                        <table class="table table-bordered table-sm">
                            <thead class="table-warning">
                                <tr>
                                    <th>ID</th>
                                    <th>Identificação</th>
                                    <th>Tipo</th>
                                    <th>Frota</th>
                                    <th>Descrição</th>
                                    <th>Fornecedor</th>
                                    <th>Valor (R$)</th>
                                    <th>Prazo (dias)</th>
                                    <th>Data Previsão</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${manutencoesPendentes.map(m => {
                                    const dataAbertura = new Date(m.data_abertura);
                                    const dataPrevisao = m.previsao_conclusao ? new Date(m.previsao_conclusao) : null;
                                    const hoje = new Date();
                                    
                                    let statusPrazo = '';
                                    if (dataPrevisao) {
                                        const diffTime = dataPrevisao - hoje;
                                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                                        
                                        if (diffDays < 0) {
                                            statusPrazo = '<span class="badge bg-danger">Atrasada</span>';
                                        } else if (diffDays <= 7) {
                                            statusPrazo = '<span class="badge bg-warning text-dark">Próxima</span>';
                                        } else {
                                            statusPrazo = '<span class="badge bg-success">No prazo</span>';
                                        }
                                    }
                                    
                                    return `
                                        <tr>
                                            <td>${m.id}</td>
                                            <td>${m.identificacao}</td>
                                            <td>${m.tipo === 'corretiva' ? 'Corretiva' : 'Preventiva'}</td>
                                            <td>${m.frota}</td>
                                            <td>${m.descricao}</td>
                                            <td>${m.fornecedor || '-'}</td>
                                            <td>R$ ${(m.valor || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                            <td>${m.prazo_liberacao || '-'}</td>
                                            <td>${dataPrevisao ? dataPrevisao.toLocaleDateString('pt-BR') + ' ' + statusPrazo : 'Não informada'}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    ` : '<p class="text-center">Nenhuma manutenção pendente.</p>'}
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-12">
                    <h4 class="text-center mb-3">Todas as Manutenções</h4>
                    <table class="table table-bordered table-sm">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Identificação</th>
                                <th>Tipo</th>
                                <th>Frota</th>
                                <th>Valor (R$)</th>
                                <th>Prazo (dias)</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${manutencoes.map(m => `
                                <tr>
                                    <td>${m.id}</td>
                                    <td>${m.identificacao}</td>
                                    <td>${m.tipo === 'corretiva' ? 'Corretiva' : 'Preventiva'}</td>
                                    <td>${m.frota}</td>
                                    <td>R$ ${(m.valor || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                    <td>${m.prazo_liberacao || '-'}</td>
                                    <td>${m.finalizada ? 'Finalizada' : 'Em Aberto'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot class="table-secondary">
                            <tr>
                                <td colspan="4" class="text-end"><strong>TOTAIS:</strong></td>
                                <td><strong>R$ ${totalValor.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong></td>
                                <td><strong>${totalPrazoLiberacao}</strong></td>
                                <td><strong>${totalManutencoes} manutenções</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    `;

    // Abrir janela de impressão
    const janelaImpressao = window.open('', '_blank');
    
    janelaImpressao.document.write(`
        <html>
        <head>
            <title>Relatório Completo de Manutenções</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
            <style>
                @page {
                    size: landscape;
                    margin: 1cm;
                }
                body { 
                    font-family: Arial, sans-serif; 
                    font-size: 12px;
                    padding: 15px;
                }
                h2 { 
                    color: #0d6efd; 
                    font-size: 1.5rem;
                }
                h4, h5 {
                    font-size: 1.1rem;
                }
                .table { 
                    font-size: 11px;
                    page-break-inside: avoid;
                }
                .card {
                    page-break-inside: avoid;
                }
                .badge {
                    font-size: 10px;
                }
                @media print {
                    body { 
                        padding: 0; 
                        margin: 0;
                    }
                    .no-print { 
                        display: none; 
                    }
                    .container-fluid {
                        width: 100%;
                    }
                }
            </style>
        </head>
        <body>
            ${conteudoRelatorio}
            <div class="no-print text-center mt-4">
                <button class="btn btn-primary" onclick="window.print()">Imprimir</button>
                <button class="btn btn-secondary" onclick="window.close()">Fechar</button>
            </div>
        </body>
        </html>
    `);
    
    janelaImpressao.document.close();
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '1050';
    alertDiv.style.minWidth = '300px';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}