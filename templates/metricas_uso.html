{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="card-header bg-info text-white">
        <i class="bi bi-speedometer"></i> Métricas de Uso - Controle de Troca de Óleo
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-plus-circle"></i> Cadastrar/Atualizar Troca de Óleo
                    </div>
                    <div class="card-body">
                        <form method="POST" action="/metricas-uso">
                            <div class="mb-3">
                                <label class="form-label">Placa do Veículo *</label>
                                <select class="form-select" name="placa" required>
                                    <option value="">Selecione a placa...</option>
                                    {% for placa in placas %}
                                        <option value="{{ placa }}">{{ placa }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Data da Última Troca *</label>
                                <input type="date" class="form-control" name="data_troca" required 
                                       max="{{ now.strftime('%Y-%m-%d') }}">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">KM na Última Troca *</label>
                                <input type="number" step="0.1" class="form-control" name="km_troca" required
                                       placeholder="Ex: 15000.0">
                            </div>
                            
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save"></i> Salvar Dados
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="bi-info-circle"></i> Informações
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <h6><i class="bi-lightbulb"></i> Como funciona:</h6>
                            <p>O sistema calcula automaticamente que a próxima troca de óleo deve ser feita a cada <strong>10.000 KM</strong> rodados após a última troca.</p>
                            <p>Os KM remanescentes são calculados com base no último odômetro registrado nos abastecimentos.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard de Status -->
        <div class="row mt-4">
            <div class="col-md-3">
                <div class="card text-center bg-primary text-white">
                    <div class="card-body">
                        <h5><i class="bi-car-front"></i> Veículos</h5>
                        <h3>{{ trocas_oleo|length }}</h3>
                        <small>Com controle de óleo</small>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card text-center bg-warning text-dark">
                    <div class="card-body">
                        <h5><i class="bi-exclamation-triangle"></i> Atenção</h5>
                        <h3>{{ trocas_oleo|selectattr('km_remanescentes', '<=', 1000)|list|length }}</h3>
                        <small>Próximos da troca</small>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card text-center bg-danger text-white">
                    <div class="card-body">
                        <h5><i class="bi-x-circle"></i> Atrasados</h5>
                        <h3>{{ trocas_oleo|selectattr('km_remanescentes', '<=', 0)|list|length }}</h3>
                        <small>Com troca vencida</small>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card text-center bg-success text-white">
                    <div class="card-body">
                        <h5><i class="bi-check-circle"></i> Em Dia</h5>
                        <h3>{{ trocas_oleo|selectattr('km_remanescentes', '>', 1000)|list|length }}</h3>
                        <small>Dentro do prazo</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabela de Controle -->
        <div class="card mt-4">
            <div class="card-header">
                <i class="bi-table"></i> Controle de Troca de Óleo por Veículo
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Placa</th>
                                <th>Última Troca</th>
                                <th class="text-end">KM na Troca</th>
                                <th class="text-end">KM Atual</th>
                                <th class="text-end">Próxima Troca</th>
                                <th class="text-end">KM Remanescentes</th>
                                <th class="text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for troca in trocas_oleo %}
                            <tr>
                                <td><span class="badge bg-secondary">{{ troca.placa }}</span></td>
                                <td>{{ troca.data_troca }}</td>
                                <td class="text-end">{{ "%.1f"|format(troca.km_troca) }}</td>
                                <td class="text-end">{{ "%.1f"|format(troca.km_atual) }}</td>
                                <td class="text-end">{{ "%.1f"|format(troca.proxima_troca_km) }}</td>
                                <td class="text-end fw-bold {% if troca.km_remanescentes <= 0 %}text-danger{% elif troca.km_remanescentes <= 1000 %}text-warning{% else %}text-success{% endif %}">
                                    {{ "%.1f"|format(troca.km_remanescentes) }}
                                </td>
                                <td class="text-center">
                                    {% if troca.km_remanescentes <= 0 %}
                                        <span class="badge bg-danger">Vencido</span>
                                    {% elif troca.km_remanescentes <= 1000 %}
                                        <span class="badge bg-warning">Atenção</span>
                                    {% else %}
                                        <span class="badge bg-success">OK</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="7" class="text-center py-4">
                                    <i class="bi-inbox display-6 text-muted"></i>
                                    <p class="text-muted mt-2">Nenhum veículo com controle de troca de óleo cadastrado.</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Gráfico de Status -->
        <div class="card mt-4">
            <div class="card-header">
                <i class="bi-pie-chart"></i> Distribuição por Status
            </div>
            <div class="card-body">
                <div class="grafico-container">
                    <canvas id="statusChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Incluir Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Dados para o gráfico
    const atrasados = {{ trocas_oleo|selectattr('km_remanescentes', '<=', 0)|list|length }};
    const atencao = {{ trocas_oleo|selectattr('km_remanescentes', '<=', 1000)|selectattr('km_remanescentes', '>', 0)|list|length }};
    const emDia = {{ trocas_oleo|selectattr('km_remanescentes', '>', 1000)|list|length }};
    
    const ctx = document.getElementById('statusChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Atrasados', 'Atenção', 'Em Dia'],
            datasets: [{
                data: [atrasados, atencao, emDia],
                backgroundColor: ['#dc3545', '#ffc107', '#28a745']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                title: {
                    display: true,
                    text: 'Status das Trocas de Óleo'
                }
            }
        }
    });
});
</script>

<style>
.grafico-container {
    position: relative;
    height: 300px;
    max-width: 400px;
    margin: 0 auto;
}

.card {
    transition: transform 0.2s;
}

.card:hover {
    transform: translateY(-2px);
}

.table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.1);
}

.badge {
    font-size: 0.85em;
}
</style>
{% endblock %}